
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-all duration-300" 
     [class.dark]="isDarkMode">
  
  <!-- Mobile Header -->
  <div *ngIf="!isLoginPage()" class="lg:hidden header-professional sticky top-0 z-50">
    <div class="flex items-center justify-between padding-section">
      <button
        (click)="toggleMobileSidebar()"
        class="btn-secondary p-2"
        aria-label="Toggle sidebar"
      >
        <mat-icon class="text-xl">menu</mat-icon>
      </button>
      
      <div class="flex items-center space-x-2">
        <mat-icon class="text-2xl text-blue-600">account_balance</mat-icon>
        <h1 class="text-lg font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">FMS</h1>
      </div>
      
      <div class="flex items-center space-x-2">
        <!-- Theme Toggle -->
        <button
          (click)="toggleTheme()"
          class="btn-secondary p-2"
          [attr.aria-label]="isDarkMode ? 'Switch to light mode' : 'Switch to dark mode'"
        >
          <mat-icon class="text-lg">{{ isDarkMode ? 'light_mode' : 'dark_mode' }}</mat-icon>
        </button>
        
        <!-- User Menu -->
        <button
          *ngIf="isLoggedIn()"
          mat-icon-button
          [matMenuTriggerFor]="userMenu"
          class="btn-primary p-2"
        >
          <mat-icon>account_circle</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Professional Sidebar -->
  <aside
    *ngIf="!isLoginPage()"
    class="fixed inset-y-0 left-0 z-40 w-80 sidebar-professional shadow-xl transform transition-all duration-300 ease-in-out lg:translate-x-0 overflow-hidden"
    [class.translate-x-0]="isMobileSidebarOpen"
    [class.-translate-x-full]="!isMobileSidebarOpen"
    [@slideInOut]
  >
    <!-- Sidebar Header -->
    <div class="relative h-20 px-6 gradient-header flex items-center justify-center">
      <div class="text-center">
        <div class="flex items-center justify-center space-x-3">
          <div class="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
            <mat-icon class="text-2xl text-white">account_balance</mat-icon>
          </div>
          <div class="text-left">
            <h2 class="text-lg font-bold text-white">Financial Management</h2>
            <p class="text-xs text-white/80">Professional Edition</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto h-[calc(100vh-5rem)]">
      
      <!-- Dashboard -->
      <div class="nav-section-header flex">
        <mat-icon class="text-sm mr-2">dashboard</mat-icon>
        Dashboard
      </div>
      
      <a
        routerLink="/dashboard"
        routerLinkActive="active"
        class="nav-item-professional flex items-center space-x-3 group"
      >
        <mat-icon class="text-lg">dashboard</mat-icon>
        <span>Overview</span>
      </a>

      <!-- User Management - Only for Super Admin -->
      <div *ngIf="currentUser?.role === 'super_admin'" class="space-y-1">
        <div class="nav-section-header flex">
          <mat-icon class="text-sm mr-2">supervisor_account</mat-icon>
          User Management
        </div>
        <a
          routerLink="/user-management"
          routerLinkActive="active"
          class="nav-item-professional flex items-center space-x-3"
        >
          <mat-icon class="text-lg">manage_accounts</mat-icon>
          <span>All Users</span>
        </a>
      </div>

      <!-- Member Management -->
      <div *ngIf="currentUser?.role === 'super_admin' || currentUser?.role === 'society_admin'" class="space-y-1">
        <div class="nav-section-header flex">
          <mat-icon class="text-sm mr-2">people</mat-icon>
          Members
        </div>
        <a
          routerLink="/master/member-details"
          routerLinkActive="active"
          class="nav-item-professional flex items-center space-x-3"
        >
          <mat-icon class="text-lg">people</mat-icon>
          <span>Member Details</span>
        </a>
      </div>

      <!-- File Menu -->
      <div class="space-y-1">
        <button
          (click)="toggleFileMenu()"
          class="nav-item-professional flex items-center justify-between w-full"
        >
          <div class="flex items-center space-x-3">
            <mat-icon class="text-lg">folder</mat-icon>
            <span>File</span>
          </div>
          <mat-icon [class.rotate-180]="isFileMenuOpen" class="transform transition-all duration-200 text-lg">expand_more</mat-icon>
        </button>

        <div *ngIf="isFileMenuOpen" class="ml-8 space-y-1 animate-slide-in" [@fadeInOut]>
          <!-- Security Submenu -->
          <button
            (click)="toggleSecurityMenu()"
            class="nav-item-professional flex items-center justify-between w-full text-sm"
          >
            <div class="flex items-center space-x-2">
              <mat-icon class="text-base">security</mat-icon>
              <span>Security</span>
            </div>
            <mat-icon [class.rotate-180]="isSecurityMenuOpen" class="transform transition-all duration-200 text-base">expand_more</mat-icon>
          </button>

          <div *ngIf="isSecurityMenuOpen" class="ml-6 space-y-1 animate-slide-in" [@fadeInOut]>
            <a *ngIf="isSuperAdmin()" 
               routerLink="/file/security/authority" 
               routerLinkActive="active" 
               class="block px-3 py-2 text-xs rounded-lg transition-all duration-200 hover:bg-white/10 text-white/70 hover:text-white">
              Authority
            </a>
            <a *ngIf="canCreateUsers()" 
               routerLink="/file/security/new-user" 
               routerLinkActive="active" 
               class="block px-3 py-2 text-xs rounded-lg transition-all duration-200 hover:bg-white/10 text-white/70 hover:text-white">
              New User
            </a>
            <a routerLink="/file/security/retrieve-password" 
               routerLinkActive="active" 
               class="block px-3 py-2 text-xs rounded-lg transition-all duration-200 hover:bg-white/10 text-white/70 hover:text-white">
              Retrieve Password
            </a>
            <a routerLink="/file/security/change-password" 
               routerLinkActive="active" 
               class="block px-3 py-2 text-xs rounded-lg transition-all duration-200 hover:bg-white/10 text-white/70 hover:text-white">
              Change Password
            </a>
            <a *ngIf="isSuperAdmin()" 
               routerLink="/file/security/admin-handover" 
               routerLinkActive="active" 
               class="block px-3 py-2 text-xs rounded-lg transition-all duration-200 hover:bg-white/10 text-white/70 hover:text-white">
              Admin Handover
            </a>
          </div>

          <a routerLink="/file/society" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">business</mat-icon>
            <span>Society</span>
          </a>
          <a *ngIf="canManageFinancialYear()" 
             routerLink="/file/create-new-year" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">calendar_today</mat-icon>
            <span>Create New Year</span>
          </a>
          <a *ngIf="canEditOpeningBalance()" 
             routerLink="/file/edit-opening-balance" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">edit</mat-icon>
            <span>Edit Opening Balance</span>
          </a>
        </div>
      </div>

      <!-- Master Menu -->
      <div *ngIf="canAccessMaster()" class="space-y-1">
        <button
          (click)="toggleMasterMenu()"
          class="nav-item-professional flex items-center justify-between w-full"
        >
          <div class="flex items-center space-x-3">
            <mat-icon class="text-lg">storage</mat-icon>
            <span>Master</span>
          </div>
          <mat-icon [class.rotate-180]="isMasterMenuOpen" class="transform transition-all duration-200 text-lg">expand_more</mat-icon>
        </button>

        <div *ngIf="isMasterMenuOpen" class="ml-8 space-y-1 animate-slide-in" [@fadeInOut]>
          <a routerLink="/master/member-details" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">people</mat-icon>
            <span>Member Details</span>
          </a>
          <a routerLink="/master/table" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">table_chart</mat-icon>
            <span>Table</span>
          </a>
          <a *ngIf="isSuperAdmin() || isSocietyAdmin()" 
             routerLink="/master/deposit-scheme" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">account_balance</mat-icon>
            <span>Deposit Scheme</span>
          </a>
          <a *ngIf="isSuperAdmin() || isSocietyAdmin()" 
             routerLink="/master/interest-master" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">trending_up</mat-icon>
            <span>Interest Master</span>
          </a>
        </div>
      </div>

      <!-- Transaction Menu -->
      <div *ngIf="canAccessTransactions()" class="space-y-1">
        <div class="nav-section-header flex">
          <mat-icon class="text-sm mr-2">receipt</mat-icon>
          Transactions
        </div>
        
        <button
          (click)="toggleTransactionMenu()"
          class="nav-item-professional flex items-center justify-between w-full"
        >
          <div class="flex items-center space-x-3">
            <mat-icon class="text-lg">receipt</mat-icon>
            <span>Transaction</span>
          </div>
          <mat-icon [class.rotate-180]="isTransactionMenuOpen" class="transform transition-all duration-200 text-lg">expand_more</mat-icon>
        </button>

        <div *ngIf="isTransactionMenuOpen" class="ml-8 space-y-1 animate-slide-in" [@fadeInOut]>
          <a routerLink="/transaction/loan-taken" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">money</mat-icon>
            <span>Loan Taken</span>
          </a>
          <a routerLink="/transaction/demand-process" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">assignment</mat-icon>
            <span>Demand Process</span>
          </a>
          <a *ngIf="isSuperAdmin() || isSocietyAdmin()" 
             routerLink="/transaction/account-closure" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">close</mat-icon>
            <span>Account Closure</span>
          </a>
          <a routerLink="/transaction/deposit-receipt" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">receipt_long</mat-icon>
            <span>Deposit Receipt</span>
          </a>
          <a routerLink="/transaction/deposit-renew" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">refresh</mat-icon>
            <span>Deposit Renew</span>
          </a>
          <a routerLink="/transaction/deposit-slip" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">description</mat-icon>
            <span>Deposit Slip</span>
          </a>
          <a routerLink="/transaction/deposit-payment" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">payment</mat-icon>
            <span>Deposit Payment</span>
          </a>
        </div>
      </div>

      <!-- Accounts Menu -->
      <div *ngIf="canAccessAccounts()" class="space-y-1">
        <div class="nav-section-header flex">
          <mat-icon class="text-sm mr-2">account_balance</mat-icon>
          Accounts
        </div>
        
        <button
          (click)="toggleAccountsMenu()"
          class="nav-item-professional flex items-center justify-between w-full"
        >
          <div class="flex items-center space-x-3">
            <mat-icon class="text-lg">account_balance</mat-icon>
            <span>Accounts</span>
          </div>
          <mat-icon [class.rotate-180]="isAccountsMenuOpen" class="transform transition-all duration-200 text-lg">expand_more</mat-icon>
        </button>

        <div *ngIf="isAccountsMenuOpen" class="ml-8 space-y-1 animate-slide-in" [@fadeInOut]>
          <a routerLink="/accounts/group" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">group_work</mat-icon>
            <span>Group</span>
          </a>
          <a routerLink="/accounts/ledger" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">book</mat-icon>
            <span>Ledger</span>
          </a>
          <a routerLink="/accounts/cash-book" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">account_balance_wallet</mat-icon>
            <span>Cash Book</span>
          </a>
          <a routerLink="/accounts/day-book" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">today</mat-icon>
            <span>Day Book</span>
          </a>
          <a routerLink="/accounts/voucher" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">receipt</mat-icon>
            <span>Voucher</span>
          </a>
          <a routerLink="/accounts/loan-receipt" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">description</mat-icon>
            <span>Loan Receipt</span>
          </a>
          <a routerLink="/accounts/trial-balance" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">balance</mat-icon>
            <span>Trial Balance</span>
          </a>
          <a routerLink="/accounts/balance-sheet" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">assessment</mat-icon>
            <span>Balance Sheet</span>
          </a>
          <a routerLink="/accounts/profit-loss" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">trending_up</mat-icon>
            <span>Profit & Loss</span>
          </a>
          <a routerLink="/accounts/receipt-payment" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">payment</mat-icon>
            <span>Receipt & Payment</span>
          </a>
        </div>
      </div>

      <!-- Reports Menu -->
      <div *ngIf="canAccessReports()" class="space-y-1">
        <div class="nav-section-header flex">
          <mat-icon class="text-sm mr-2">assessment</mat-icon>
          Reports
        </div>
        
        <button
          (click)="toggleReportsMenu()"
          class="nav-item-professional flex items-center justify-between w-full"
        >
          <div class="flex items-center space-x-3">
            <mat-icon class="text-lg">assessment</mat-icon>
            <span>Reports</span>
          </div>
          <mat-icon [class.rotate-180]="isReportsMenuOpen" class="transform transition-all duration-200 text-lg">expand_more</mat-icon>
        </button>

        <div *ngIf="isReportsMenuOpen" class="ml-8 space-y-1 animate-slide-in" [@fadeInOut]>
          <a routerLink="/reports/employees" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">people</mat-icon>
            <span>Employees</span>
          </a>
          <a routerLink="/reports/voucher" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">receipt</mat-icon>
            <span>Voucher</span>
          </a>
          <a routerLink="/reports/opening-balance" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">play_arrow</mat-icon>
            <span>Opening Balance</span>
          </a>
          <a routerLink="/reports/closing-balance" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">stop</mat-icon>
            <span>Closing Balance</span>
          </a>
          <a routerLink="/reports/loan" 
             routerLinkActive="active" 
             class="nav-item-professional flex items-center space-x-2 text-sm">
            <mat-icon class="text-base">money</mat-icon>
            <span>Loan</span>
          </a>
        </div>
      </div>

      <!-- Other Menu Items -->
      <div class="space-y-1">
        <div class="nav-section-header flex">
          <mat-icon class="text-sm mr-2">more_horiz</mat-icon>
          Other
        </div>
        
        <a
          routerLink="/statement"
          routerLinkActive="active"
          class="nav-item-professional flex items-center space-x-3"
        >
          <mat-icon class="text-lg">description</mat-icon>
          <span>Statement</span>
        </a>

        <a *ngIf="canAccessBackup()"
          routerLink="/backup"
          routerLinkActive="active"
          class="nav-item-professional flex items-center space-x-3"
        >
          <mat-icon class="text-lg">backup</mat-icon>
          <span>Backup</span>
        </a>

        <a *ngIf="canAccessAdmin()"
          routerLink="/admin"
          routerLinkActive="active"
          class="nav-item-professional flex items-center space-x-3"
        >
          <mat-icon class="text-lg">admin_panel_settings</mat-icon>
          <span>Admin</span>
        </a>

        <a *ngIf="canManageFinancialYear()"
          routerLink="/new-year"
          routerLinkActive="active"
          class="nav-item-professional flex items-center space-x-3"
        >
          <mat-icon class="text-lg">calendar_today</mat-icon>
          <span>New Year</span>
        </a>
      </div>

      <!-- Logout -->
      <div class="pt-4 border-t border-white/20 mt-6">
        <a
          routerLink="/login"
          class="nav-item-professional flex items-center space-x-3 !text-red-300 hover:!text-red-200 hover:!bg-red-500/20"
        >
          <mat-icon class="text-lg">exit_to_app</mat-icon>
          <span>Exit</span>
        </a>
      </div>
    </nav>
  </aside>

  <!-- Mobile sidebar overlay -->
  <div
    *ngIf="isMobileSidebarOpen && !isLoginPage()"
    class="fixed inset-0 z-30 bg-black/50 backdrop-blur-sm lg:hidden transition-opacity duration-300"
    (click)="closeMobileSidebar()"
    [@fadeInOut]
  ></div>

  <!-- Main content -->
  <div [class.lg:ml-80]="!isLoginPage()">
    <!-- Desktop Header -->
    <header *ngIf="!isLoginPage()" class="hidden lg:block header-professional sticky top-0 z-20">
      <div class="px-6 py-4">
        <div class="flex items-center justify-between">
          <!-- Page Title & Breadcrumb will be handled by individual components -->
          <div class="flex items-center space-x-4">
            <mat-icon class="text-blue-600 text-2xl">account_balance</mat-icon>
            <div>
              <h1 class="text-page-title bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                Financial Management System
              </h1>
              <p class="text-caption text-gray-500 dark:text-gray-400">Professional Edition</p>
            </div>
          </div>

          <div class="flex items-center space-x-4">
            <!-- Theme toggle -->
            <div class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800">
              <mat-icon class="text-yellow-500 text-lg">light_mode</mat-icon>
              <mat-slide-toggle
                [(ngModel)]="isDarkMode"
                (change)="toggleTheme()"
                color="primary"
                matTooltip="Toggle Dark Mode">
              </mat-slide-toggle>
              <mat-icon class="text-blue-500 text-lg">dark_mode</mat-icon>
            </div>

            <!-- User info -->
            <div *ngIf="isLoggedIn()" class="text-caption px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300">
              <div class="flex items-center space-x-2">
                <mat-icon class="text-blue-500 text-lg">business</mat-icon>
                <span>{{ currentUser?.societyName ? currentUser?.societyName + ' - ' : '' }}{{ getUserRoleDisplayName() }}</span>
              </div>
            </div>

            <!-- User menu -->
            <button
              *ngIf="isLoggedIn()"
              mat-icon-button
              [matMenuTriggerFor]="userMenu"
              class="btn-primary w-10 h-10"
            >
              <mat-icon>account_circle</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Page content with proper spacing -->
    <main [class]="isLoginPage() ? 'min-h-screen' : 'content-professional'" class="animate-fade-in">
      <div [class]="isLoginPage() ? '' : 'max-w-7xl mx-auto'" class="padding-section">
        <router-outlet></router-outlet>
      </div>
    </main>
  </div>

  <!-- User menu -->
  <mat-menu #userMenu="matMenu" class="mt-2">
    <div class="px-6 py-4 border-b gradient-header">
      <p class="text-lg font-bold text-white">{{currentUserName}}</p>
      <p class="text-sm text-white/80">{{ getUserRoleDisplayName() }}</p>
    </div>
    <button mat-menu-item class="flex items-center px-6 py-3 text-body font-medium transition-all duration-200 hover:bg-gray-50 dark:hover:bg-gray-800">
      <mat-icon class="mr-3 text-blue-500">person</mat-icon>
      Profile
    </button>
    <button mat-menu-item class="flex items-center px-6 py-3 text-body font-medium transition-all duration-200 hover:bg-gray-50 dark:hover:bg-gray-800">
      <mat-icon class="mr-3 text-blue-500">settings</mat-icon>
      Settings
    </button>
    <button mat-menu-item (click)="logout()" class="flex items-center px-6 py-3 text-body font-medium text-red-600 transition-all duration-200 hover:bg-red-50 dark:hover:bg-red-900/20">
      <mat-icon class="mr-3">logout</mat-icon>
      Logout
    </button>
  </mat-menu>
</div>
