<div class="page-container" [class.dark]="isDarkMode">

  <!-- Professional Sidebar -->
  <aside
    *ngIf="!isLoginPage()"
    class="sidebar"
    [class.open]="isMobileSidebarOpen"
    [@slideInOut]
  >
    <!-- Sidebar Header -->
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <div class="flex items-center justify-center w-12 h-12 bg-white/20 rounded-xl backdrop-blur-sm">
          <mat-icon class="text-2xl text-white">account_balance</mat-icon>
        </div>
        <div>
          <h2 class="text-lg font-bold text-white">Financial MS</h2>
          <p class="text-xs text-white/70">Professional Edition</p>
        </div>
      </div>
    </div>

    <!-- Sidebar Navigation -->
    <nav class="sidebar-nav">

      <!-- Dashboard Section -->
      <div class="nav-section">
        <div class="nav-section-title">
          <mat-icon class="inline-block w-4 h-4 mr-2">dashboard</mat-icon>
          Overview
        </div>
        <a
          routerLink="/dashboard"
          routerLinkActive="active"
          class="nav-item"
        >
          <mat-icon>dashboard</mat-icon>
          <span>Dashboard</span>
        </a>
      </div>

      <!-- User Management - Super Admin Only -->
      <div *ngIf="currentUser?.role === 'super_admin'" class="nav-section">
        <div class="nav-section-title">
          <mat-icon class="inline-block w-4 h-4 mr-2">supervisor_account</mat-icon>
          User Management
        </div>
        <a
          routerLink="/user-management"
          routerLinkActive="active"
          class="nav-item"
        >
          <mat-icon>manage_accounts</mat-icon>
          <span>All Users</span>
        </a>
      </div>

      <!-- File Management -->
      <div class="nav-section">
        <div class="nav-section-title">
          <mat-icon class="inline-block w-4 h-4 mr-2">folder</mat-icon>
          File Management
        </div>

        <!-- File Menu with Expandable Submenus -->
        <div class="nav-item" (click)="toggleFileMenu()">
          <mat-icon>folder</mat-icon>
          <span>File</span>
          <mat-icon class="ml-auto transform transition-transform" [class.rotate-180]="isFileMenuOpen">expand_more</mat-icon>
        </div>

        <div *ngIf="isFileMenuOpen" class="nav-submenu animate-slide-in" [@fadeInOut]>
          <!-- Security Submenu -->
          <div class="nav-item" (click)="toggleSecurityMenu()">
            <mat-icon>security</mat-icon>
            <span>Security</span>
            <mat-icon class="ml-auto transform transition-transform text-sm" [class.rotate-180]="isSecurityMenuOpen">expand_more</mat-icon>
          </div>

          <div *ngIf="isSecurityMenuOpen" class="nav-submenu animate-slide-in" [@fadeInOut]>
            <a *ngIf="isSuperAdmin()"
               routerLink="/file/security/authority"
               routerLinkActive="active"
               class="nav-item">
              <mat-icon class="text-sm">admin_panel_settings</mat-icon>
              <span>Authority</span>
            </a>
            <a *ngIf="canCreateUsers()"
               routerLink="/file/security/new-user"
               routerLinkActive="active"
               class="nav-item">
              <mat-icon class="text-sm">person_add</mat-icon>
              <span>New User</span>
            </a>
            <a routerLink="/file/security/retrieve-password"
               routerLinkActive="active"
               class="nav-item">
              <mat-icon class="text-sm">lock_reset</mat-icon>
              <span>Retrieve Password</span>
            </a>
            <a routerLink="/file/security/change-password"
               routerLinkActive="active"
               class="nav-item">
              <mat-icon class="text-sm">key</mat-icon>
              <span>Change Password</span>
            </a>
            <a *ngIf="isSuperAdmin()"
               routerLink="/file/security/admin-handover"
               routerLinkActive="active"
               class="nav-item">
              <mat-icon class="text-sm">transfer_within_a_station</mat-icon>
              <span>Admin Handover</span>
            </a>
          </div>

          <a routerLink="/file/society"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>business</mat-icon>
            <span>Society</span>
          </a>
          <a *ngIf="canManageFinancialYear()"
             routerLink="/file/create-new-year"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>calendar_today</mat-icon>
            <span>Create New Year</span>
          </a>
          <a *ngIf="canEditOpeningBalance()"
             routerLink="/file/edit-opening-balance"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>edit</mat-icon>
            <span>Edit Opening Balance</span>
          </a>
        </div>
      </div>

      <!-- Master Data -->
      <div *ngIf="canAccessMaster()" class="nav-section">
        <div class="nav-section-title">
          <mat-icon class="inline-block w-4 h-4 mr-2">storage</mat-icon>
          Master Data
        </div>

        <div class="nav-item" (click)="toggleMasterMenu()">
          <mat-icon>storage</mat-icon>
          <span>Master</span>
          <mat-icon class="ml-auto transform transition-transform" [class.rotate-180]="isMasterMenuOpen">expand_more</mat-icon>
        </div>

        <div *ngIf="isMasterMenuOpen" class="nav-submenu animate-slide-in" [@fadeInOut]>
          <a routerLink="/master/member-details"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>people</mat-icon>
            <span>Member Details</span>
          </a>
          <a routerLink="/master/table"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>table_chart</mat-icon>
            <span>Table</span>
          </a>
          <a *ngIf="isSuperAdmin() || isSocietyAdmin()"
             routerLink="/master/deposit-scheme"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>account_balance</mat-icon>
            <span>Deposit Scheme</span>
          </a>
          <a *ngIf="isSuperAdmin() || isSocietyAdmin()"
             routerLink="/master/interest-master"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>trending_up</mat-icon>
            <span>Interest Master</span>
          </a>
        </div>
      </div>

      <!-- Transactions -->
      <div *ngIf="canAccessTransactions()" class="nav-section">
        <div class="nav-section-title">
          <mat-icon class="inline-block w-4 h-4 mr-2">receipt</mat-icon>
          Transactions
        </div>

        <div class="nav-item" (click)="toggleTransactionMenu()">
          <mat-icon>receipt</mat-icon>
          <span>Transaction</span>
          <mat-icon class="ml-auto transform transition-transform" [class.rotate-180]="isTransactionMenuOpen">expand_more</mat-icon>
        </div>

        <div *ngIf="isTransactionMenuOpen" class="nav-submenu animate-slide-in" [@fadeInOut]>
          <a routerLink="/transaction/loan-taken"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>money</mat-icon>
            <span>Loan Taken</span>
          </a>
          <a routerLink="/transaction/demand-process"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>assignment</mat-icon>
            <span>Demand Process</span>
          </a>
          <a *ngIf="isSuperAdmin() || isSocietyAdmin()"
             routerLink="/transaction/account-closure"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>close</mat-icon>
            <span>Account Closure</span>
          </a>
          <a routerLink="/transaction/deposit-receipt"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>receipt_long</mat-icon>
            <span>Deposit Receipt</span>
          </a>
          <a routerLink="/transaction/deposit-renew"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>refresh</mat-icon>
            <span>Deposit Renew</span>
          </a>
          <a routerLink="/transaction/deposit-slip"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>description</mat-icon>
            <span>Deposit Slip</span>
          </a>
          <a routerLink="/transaction/deposit-payment"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>payment</mat-icon>
            <span>Deposit Payment</span>
          </a>
        </div>
      </div>

      <!-- Accounts -->
      <div *ngIf="canAccessAccounts()" class="nav-section">
        <div class="nav-section-title">
          <mat-icon class="inline-block w-4 h-4 mr-2">account_balance</mat-icon>
          Accounting
        </div>

        <div class="nav-item" (click)="toggleAccountsMenu()">
          <mat-icon>account_balance</mat-icon>
          <span>Accounts</span>
          <mat-icon class="ml-auto transform transition-transform" [class.rotate-180]="isAccountsMenuOpen">expand_more</mat-icon>
        </div>

        <div *ngIf="isAccountsMenuOpen" class="nav-submenu animate-slide-in" [@fadeInOut]>
          <a routerLink="/accounts/group"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>group_work</mat-icon>
            <span>Group</span>
          </a>
          <a routerLink="/accounts/ledger"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>book</mat-icon>
            <span>Ledger</span>
          </a>
          <a routerLink="/accounts/cash-book"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>account_balance_wallet</mat-icon>
            <span>Cash Book</span>
          </a>
          <a routerLink="/accounts/day-book"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>today</mat-icon>
            <span>Day Book</span>
          </a>
          <a routerLink="/accounts/voucher"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>receipt</mat-icon>
            <span>Voucher</span>
          </a>
          <a routerLink="/accounts/loan-receipt"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>description</mat-icon>
            <span>Loan Receipt</span>
          </a>
          <a routerLink="/accounts/trial-balance"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>balance</mat-icon>
            <span>Trial Balance</span>
          </a>
          <a routerLink="/accounts/balance-sheet"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>assessment</mat-icon>
            <span>Balance Sheet</span>
          </a>
          <a routerLink="/accounts/profit-loss"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>trending_up</mat-icon>
            <span>Profit & Loss</span>
          </a>
          <a routerLink="/accounts/receipt-payment"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>payment</mat-icon>
            <span>Receipt & Payment</span>
          </a>
        </div>
      </div>

      <!-- Reports -->
      <div *ngIf="canAccessReports()" class="nav-section">
        <div class="nav-section-title">
          <mat-icon class="inline-block w-4 h-4 mr-2">assessment</mat-icon>
          Reports & Analytics
        </div>

        <div class="nav-item" (click)="toggleReportsMenu()">
          <mat-icon>assessment</mat-icon>
          <span>Reports</span>
          <mat-icon class="ml-auto transform transition-transform" [class.rotate-180]="isReportsMenuOpen">expand_more</mat-icon>
        </div>

        <div *ngIf="isReportsMenuOpen" class="nav-submenu animate-slide-in" [@fadeInOut]>
          <a routerLink="/reports/employees"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>people</mat-icon>
            <span>Employees</span>
          </a>
          <a routerLink="/reports/voucher"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>receipt</mat-icon>
            <span>Voucher</span>
          </a>
          <a routerLink="/reports/opening-balance"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>play_arrow</mat-icon>
            <span>Opening Balance</span>
          </a>
          <a routerLink="/reports/closing-balance"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>stop</mat-icon>
            <span>Closing Balance</span>
          </a>
          <a routerLink="/reports/loan"
             routerLinkActive="active"
             class="nav-item">
            <mat-icon>money</mat-icon>
            <span>Loan</span>
          </a>
        </div>
      </div>

      <!-- System Tools -->
      <div class="nav-section">
        <div class="nav-section-title">
          <mat-icon class="inline-block w-4 h-4 mr-2">settings</mat-icon>
          System Tools
        </div>

        <a routerLink="/statement"
           routerLinkActive="active"
           class="nav-item">
          <mat-icon>description</mat-icon>
          <span>Statement</span>
        </a>

        <a *ngIf="canAccessBackup()"
           routerLink="/backup"
           routerLinkActive="active"
           class="nav-item">
          <mat-icon>backup</mat-icon>
          <span>Backup</span>
        </a>

        <a *ngIf="canAccessAdmin()"
           routerLink="/admin"
           routerLinkActive="active"
           class="nav-item">
          <mat-icon>admin_panel_settings</mat-icon>
          <span>Admin</span>
        </a>

        <a *ngIf="canManageFinancialYear()"
           routerLink="/new-year"
           routerLinkActive="active"
           class="nav-item">
          <mat-icon>calendar_today</mat-icon>
          <span>New Year</span>
        </a>
      </div>

      <!-- Logout -->
      <div class="nav-section">
        <a
          (click)="logout()"
          class="nav-item text-red-300 hover:text-red-200 hover:bg-red-500/20 cursor-pointer">
          <mat-icon>exit_to_app</mat-icon>
          <span>Exit</span>
        </a>
      </div>
    </nav>
  </aside>

  <!-- Mobile Overlay -->
  <div
    *ngIf="isMobileSidebarOpen && !isLoginPage()"
    class="mobile-overlay lg:hidden"
    (click)="closeMobileSidebar()"
    [@fadeInOut]
  ></div>

  <!-- Main Content Area -->
  <div [class]="isLoginPage() ? '' : 'main-content'">

    <!-- Professional Header -->
    <header *ngIf="!isLoginPage()" class="header">
      <div class="header-content">
        <!-- Left Side - Mobile Menu & Title -->
        <div class="header-left">
          <!-- Mobile Menu Toggle -->
          <button
            class="lg:hidden btn btn-secondary btn-icon"
            (click)="toggleMobileSidebar()"
            aria-label="Toggle sidebar"
          >
            <mat-icon>menu</mat-icon>
          </button>

          <!-- Page Title -->
          <div class="hidden lg:block">
            <h1 class="text-page-title">Financial Management System</h1>
            <p class="text-caption text-gray-500 dark:text-gray-400">Professional Edition</p>
          </div>

          <!-- Mobile Title -->
          <div class="lg:hidden flex items-center gap-3">
            <mat-icon class="text-2xl text-blue-600">account_balance</mat-icon>
            <h1 class="text-lg font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">FMS</h1>
          </div>
        </div>

        <!-- Right Side - Theme Toggle, User Info, Profile -->
        <div class="header-right">
          <!-- Theme Toggle -->
          <div class="theme-toggle">
            <mat-icon class="text-yellow-500 text-lg">light_mode</mat-icon>
            <mat-slide-toggle
              [(ngModel)]="isDarkMode"
              (change)="toggleTheme()"
              color="primary">
            </mat-slide-toggle>
            <mat-icon class="text-blue-500 text-lg">dark_mode</mat-icon>
          </div>

          <!-- User Info (Desktop Only) -->
          <div *ngIf="isLoggedIn()" class="hidden lg:block text-caption px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg">
            <div class="flex items-center gap-2 text-gray-700 dark:text-gray-300">
              <mat-icon class="text-blue-500 text-lg">business</mat-icon>
              <span>{{ currentUser?.societyName ? currentUser?.societyName + ' - ' : '' }}{{ getUserRoleDisplayName() }}</span>
            </div>
          </div>

          <!-- User Profile Menu -->
          <button
            *ngIf="isLoggedIn()"
            mat-icon-button
            [matMenuTriggerFor]="userMenu"
            class="btn btn-primary btn-icon"
          >
            <mat-icon>account_circle</mat-icon>
          </button>
        </div>
      </div>
    </header>

    <!-- Page Content -->
    <main class="content-area animate-fade-in">
      <router-outlet></router-outlet>
    </main>
  </div>

  <!-- User Profile Menu -->
  <mat-menu #userMenu="matMenu" class="mt-2">
    <div class="px-6 py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white">
      <p class="text-lg font-bold">{{currentUserName}}</p>
      <p class="text-sm opacity-90">{{ getUserRoleDisplayName() }}</p>
    </div>
    <button mat-menu-item class="flex items-center px-6 py-3 hover:bg-gray-50 dark:hover:bg-gray-800">
      <mat-icon class="mr-3 text-blue-500">person</mat-icon>
      Profile Settings
    </button>
    <button mat-menu-item class="flex items-center px-6 py-3 hover:bg-gray-50 dark:hover:bg-gray-800">
      <mat-icon class="mr-3 text-blue-500">notifications</mat-icon>
      Notifications
    </button>
    <button mat-menu-item class="flex items-center px-6 py-3 hover:bg-gray-50 dark:hover:bg-gray-800">
      <mat-icon class="mr-3 text-blue-500">settings</mat-icon>
      Account Settings
    </button>
    <mat-divider></mat-divider>
    <button mat-menu-item (click)="logout()" class="flex items-center px-6 py-3 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20">
      <mat-icon class="mr-3">logout</mat-icon>
      Logout
    </button>
  </mat-menu>
</div>