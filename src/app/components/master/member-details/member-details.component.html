<div class="max-w-7xl mx-auto p-6">
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
    <h1 class="text-3xl font-bold text-gray-900">Member Details</h1>
    <div class="flex flex-col sm:flex-row gap-4 items-stretch sm:items-center">
      <mat-form-field class="w-full sm:w-80">
        <mat-label>Search Members</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="Search by name, member ID, or phone">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
      <button mat-raised-button color="primary" class="w-full sm:w-auto whitespace-nowrap" (click)="openMemberForm()">
        <mat-icon>add</mat-icon>
        Add New Member
      </button>
    </div>
  </div>
</div>

<!-- Access Denied Message -->
<mat-card *ngIf="!canCreateMembers && !canEditMembers" class="access-denied bg-red-50 border border-red-200 p-4 rounded-lg shadow-sm mb-6">
  <mat-card-content>
    <div class="flex items-center gap-3">
      <mat-icon color="warn" class="text-red-600">block</mat-icon>
      <h3 class="text-lg font-semibold text-red-800">Access Denied</h3>
    </div>
    <p class="text-gray-700 mt-2">You don't have permission to manage members. Only Super Admins and Society Admins can create and manage members.</p>
  </mat-card-content>
</mat-card>

<!-- Members List -->
<mat-card class="shadow-lg mb-6" *ngIf="canCreateMembers || canEditMembers">
  <mat-card-header class="bg-gray-50 border-b">
    <mat-card-title class="text-xl font-semibold text-gray-900">Members List ({{filteredMembers.length}})</mat-card-title>
  </mat-card-header>
  <mat-card-content class="p-0">
    <div class="table-controls p-4 pb-0">
      <mat-form-field appearance="outline" class="w-full sm:w-80">
        <mat-label>Search Members</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="Search by name, phone, or member no">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>

    <!-- Desktop Table View -->
    <div class="hidden lg:block">
      <mat-card class="shadow-lg">
        <mat-card-header class="bg-gray-50 border-b">
          <mat-card-title class="text-xl font-semibold text-gray-900">Members List</mat-card-title>
        </mat-card-header>
        <mat-card-content class="p-0">
          <div class="overflow-x-auto">
            <table mat-table [dataSource]="filteredMembers" class="w-full">
              <!-- Member No Column -->
              <ng-container matColumnDef="memberNo">
                <th mat-header-cell *matHeaderCellDef class="font-semibold text-gray-900 px-4 py-3 text-left">Member No</th>
                <td mat-cell *matCellDef="let member" class="text-gray-700 px-4 py-2">{{member.memberNo}}</td>
              </ng-container>

              <!-- Name Column -->
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef class="font-semibold text-gray-900 px-4 py-3 text-left">Name</th>
                <td mat-cell *matCellDef="let member" class="text-gray-700 px-4 py-2 font-medium">{{member.name}}</td>
              </ng-container>

              <!-- Mobile Column -->
              <ng-container matColumnDef="mobile">
                <th mat-header-cell *matHeaderCellDef class="font-semibold text-gray-900 px-4 py-3 text-left">Mobile</th>
                <td mat-cell *matCellDef="let member" class="text-gray-700 px-4 py-2">{{member.mobile}}</td>
              </ng-container>

              <!-- Branch Column -->
              <ng-container matColumnDef="branch">
                <th mat-header-cell *matHeaderCellDef class="font-semibold text-gray-900 px-4 py-3 text-left">Branch</th>
                <td mat-cell *matCellDef="let member" class="text-gray-700 px-4 py-2">{{member.branch}}</td>
              </ng-container>

              <!-- DOJ Society Column -->
              <ng-container matColumnDef="dojSociety">
                <th mat-header-cell *matHeaderCellDef class="font-semibold text-gray-900 px-4 py-3 text-left">DOJ Society</th>
                <td mat-cell *matCellDef="let member" class="text-gray-700 px-4 py-2">{{member.dojSociety | date}}</td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef class="font-semibold text-gray-900 px-4 py-3 text-left">Status</th>
                <td mat-cell *matCellDef="let member" class="text-gray-700 px-4 py-2">
                  <span [class]="'px-2 py-1 text-xs font-semibold rounded-full ' + (member.status === 'Active' ? 'text-green-800 bg-green-100' : member.status === 'Inactive' ? 'text-red-800 bg-red-100' : member.status === 'Suspended' ? 'text-yellow-800 bg-yellow-100' : 'text-gray-800 bg-gray-100')">
                    {{member.status}}
                  </span>
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="font-semibold text-gray-900 px-4 py-3 text-left">Actions</th>
                <td mat-cell *matCellDef="let member" class="text-gray-700 px-4 py-2">
                  <div class="flex gap-2">
                    <button mat-icon-button color="primary" (click)="editMember(member)" [disabled]="!canEditMembers" matTooltip="Edit Member" class="hover:bg-blue-50 p-2">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" (click)="deleteMember(member.id)" [disabled]="!canEditMembers" matTooltip="Delete Member" class="hover:bg-red-50 p-2">
                      <mat-icon>delete</mat-icon>
                    </button>
                    <button mat-icon-button color="accent" (click)="viewMember(member)" matTooltip="View Details" class="hover:bg-purple-50 p-2">
                      <mat-icon>visibility</mat-icon>
                    </button>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns" class="bg-gray-100"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="hover:bg-gray-50"></tr>
            </table>
          </div>

          <div class="no-data p-6 text-center text-gray-500" *ngIf="filteredMembers.length === 0">
            <mat-icon class="text-5xl text-gray-400">people_outline</mat-icon>
            <h3 class="text-xl font-semibold mt-2">No members found</h3>
            <p>{{filteredMembers.length === 0 && members.length === 0 ? 'Start by adding your first member' : 'Try adjusting your search criteria'}}</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Mobile Card View -->
    <div class="block lg:hidden">
      <div class="grid gap-4">
        <mat-card *ngFor="let member of filteredMembers" class="shadow-md hover:shadow-lg transition-shadow">
          <mat-card-header class="pb-3">
            <mat-card-title class="text-lg font-semibold text-gray-900">{{member.name}}</mat-card-title>
            <mat-card-subtitle class="text-sm text-gray-600">ID: {{member.memberNo}}</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content class="space-y-2">
            <p class="text-sm"><span class="font-semibold text-gray-700">Mobile:</span> <span class="text-gray-600">{{member.mobile}}</span></p>
            <p class="text-sm"><span class="font-semibold text-gray-700">Branch:</span> <span class="text-gray-600">{{member.branch}}</span></p>
            <p class="text-sm"><span class="font-semibold text-gray-700">Status:</span>
              <span [class]="'px-2 py-1 text-xs font-semibold rounded-full ' + (member.status === 'Active' ? 'text-green-800 bg-green-100' : member.status === 'Inactive' ? 'text-red-800 bg-red-100' : member.status === 'Suspended' ? 'text-yellow-800 bg-yellow-100' : 'text-gray-800 bg-gray-100')">
                {{member.status}}
              </span>
            </p>
          </mat-card-content>
          <mat-card-actions class="flex flex-col sm:flex-row gap-2 p-4">
            <button mat-button color="primary" (click)="editMember(member)" [disabled]="!canEditMembers" class="w-full sm:w-auto">
              <mat-icon>edit</mat-icon> Edit
            </button>
            <button mat-button color="accent" (click)="viewMember(member)" class="w-full sm:w-auto">
              <mat-icon>visibility</mat-icon> View
            </button>
            <button mat-button color="warn" (click)="deleteMember(member.id)" [disabled]="!canEditMembers" class="w-full sm:w-auto">
              <mat-icon>delete</mat-icon> Delete
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
      <div class="no-data p-6 text-center text-gray-500" *ngIf="filteredMembers.length === 0">
        <mat-icon class="text-5xl text-gray-400">people_outline</mat-icon>
        <h3 class="text-xl font-semibold mt-2">No members found</h3>
        <p>{{filteredMembers.length === 0 && members.length === 0 ? 'Start by adding your first member' : 'Try adjusting your search criteria'}}</p>
      </div>
    </div>
  </mat-card-content>
</mat-card>

<!-- Offcanvas Form -->
<mat-drawer-container class="fixed inset-0 z-50" autosize>
  <mat-drawer #memberFormSidenav mode="over" position="end" class="w-full max-w-2xl">
    <div class="h-full flex flex-col bg-white">
      <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gray-50">
        <h2 class="text-xl font-semibold text-gray-900">{{editingMember ? 'Edit Member' : 'Add New Member'}}</h2>
        <button mat-icon-button (click)="closeMemberForm()" class="text-gray-500 hover:text-gray-700">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <form [formGroup]="memberForm" (ngSubmit)="saveMember()" class="flex-1 overflow-y-auto p-6">
        <mat-tab-group class="member-tabs">

          <!-- General Tab -->
          <mat-tab label="General">
            <div class="tab-content p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Member No</mat-label>
                  <input matInput formControlName="memberNo" readonly>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Name</mat-label>
                  <input matInput formControlName="name" required>
                  <mat-error *ngIf="memberForm.get('name')?.hasError('required')">Name is required</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>F/H Name</mat-label>
                  <input matInput formControlName="fatherHusbandName" required>
                </mat-form-field>

                <mat-form-field appearance="outline" class="md:col-span-2 w-full">
                  <mat-label>Office Address</mat-label>
                  <textarea matInput formControlName="officeAddress" rows="2"></textarea>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>City</mat-label>
                  <input matInput formControlName="city" required>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Phone (Off.)</mat-label>
                  <input matInput formControlName="phoneOffice">
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Branch</mat-label>
                  <mat-select formControlName="branch">
                    <mat-option value="Main Branch">Main Branch</mat-option>
                    <mat-option value="Branch A">Branch A</mat-option>
                    <mat-option value="Branch B">Branch B</mat-option>
                    <mat-option value="Branch C">Branch C</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Phone (Res.)</mat-label>
                  <input matInput formControlName="phoneResidence">
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Designation</mat-label>
                  <input matInput formControlName="designation">
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Mobile</mat-label>
                  <input matInput formControlName="mobile" required>
                </mat-form-field>

                <mat-form-field appearance="outline" class="md:col-span-2 w-full">
                  <mat-label>Residence Address</mat-label>
                  <textarea matInput formControlName="residenceAddress" rows="2" required></textarea>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Date of Birth</mat-label>
                  <input matInput [matDatepicker]="dobPicker" formControlName="dob">
                  <mat-datepicker-toggle matSuffix [for]="dobPicker"></mat-datepicker-toggle>
                  <mat-datepicker #dobPicker></mat-datepicker>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>DOJ Society</mat-label>
                  <input matInput [matDatepicker]="dojSocietyPicker" formControlName="dojSociety">
                  <mat-datepicker-toggle matSuffix [for]="dojSocietyPicker"></mat-datepicker-toggle>
                  <mat-datepicker #dojSocietyPicker></mat-datepicker>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Email</mat-label>
                  <input matInput type="email" formControlName="email">
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>DOJ</mat-label>
                  <input matInput [matDatepicker]="dojPicker" formControlName="doj">
                  <mat-datepicker-toggle matSuffix [for]="dojPicker"></mat-datepicker-toggle>
                  <mat-datepicker #dojPicker></mat-datepicker>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>DOR</mat-label>
                  <input matInput [matDatepicker]="dorPicker" formControlName="dor">
                  <mat-datepicker-toggle matSuffix [for]="dorPicker"></mat-datepicker-toggle>
                  <mat-datepicker #dorPicker></mat-datepicker>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Nominee</mat-label>
                  <input matInput formControlName="nominee">
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Nominee Relation</mat-label>
                  <mat-select formControlName="nomineeRelation">
                    <mat-option value="Spouse">Spouse</mat-option>
                    <mat-option value="Son">Son</mat-option>
                    <mat-option value="Daughter">Daughter</mat-option>
                    <mat-option value="Father">Father</mat-option>
                    <mat-option value="Mother">Mother</mat-option>
                    <mat-option value="Brother">Brother</mat-option>
                    <mat-option value="Sister">Sister</mat-option>
                    <mat-option value="Other">Other</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
          </mat-tab>

          <!-- Photo & Opening Balance Tab -->
          <mat-tab label="Photo & Opening Balance">
            <div class="tab-content p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="photo-upload-section md:col-span-2">
                  <h3 class="text-lg font-semibold text-gray-700 mb-4">Photo & Signature</h3>
                  <div class="flex flex-col sm:flex-row gap-4">
                    <div class="upload-item flex-1">
                      <label class="block text-sm font-medium text-gray-700 mb-2">Member Photo</label>
                      <div class="image-upload-area w-full h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:border-blue-500" (click)="photoInput.click()">
                        <img *ngIf="photoPreview" [src]="photoPreview" alt="Member Photo" class="w-full h-full object-cover rounded-lg">
                        <div *ngIf="!photoPreview" class="flex flex-col items-center justify-center text-gray-500">
                          <mat-icon>add_a_photo</mat-icon>
                          <span class="text-sm mt-1">Click to upload photo</span>
                        </div>
                      </div>
                      <input #photoInput type="file" accept="image/*" (change)="onPhotoSelected($event)" style="display: none">
                    </div>

                    <div class="upload-item flex-1">
                      <label class="block text-sm font-medium text-gray-700 mb-2">Signature</label>
                      <div class="image-upload-area w-full h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:border-blue-500" (click)="signatureInput.click()">
                        <img *ngIf="signaturePreview" [src]="signaturePreview" alt="Signature" class="w-full h-full object-cover rounded-lg">
                        <div *ngIf="!signaturePreview" class="flex flex-col items-center justify-center text-gray-500">
                          <mat-icon>edit</mat-icon>
                          <span class="text-sm mt-1">Click to upload signature</span>
                        </div>
                      </div>
                      <input #signatureInput type="file" accept="image/*" (change)="onSignatureSelected($event)" style="display: none">
                    </div>
                  </div>
                </div>

                <div class="section-divider col-span-2 my-6 border-t border-gray-200"></div>

                <h3 class="col-span-2 text-lg font-semibold text-gray-700 mb-4">Opening Balance</h3>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Opening Balance (Share)</mat-label>
                  <input matInput type="number" formControlName="openingBalanceShare">
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Opening Balance (CR)</mat-label>
                  <input matInput type="number" formControlName="openingBalanceCR">
                </mat-form-field>

                <h3 class="col-span-2 text-lg font-semibold text-gray-700 mb-4">Bank Details</h3>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Bank Name</mat-label>
                  <input matInput formControlName="bankName">
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Payable At</mat-label>
                  <input matInput formControlName="bankPayableAt">
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Account No</mat-label>
                  <input matInput formControlName="bankAccountNo">
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Status</mat-label>
                  <mat-select formControlName="status">
                    <mat-option value="Active">Active</mat-option>
                    <mat-option value="Inactive">Inactive</mat-option>
                    <mat-option value="Suspended">Suspended</mat-option>
                    <mat-option value="Closed">Closed</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Status Date</mat-label>
                  <input matInput [matDatepicker]="statusDatePicker" formControlName="statusDate">
                  <mat-datepicker-toggle matSuffix [for]="statusDatePicker"></mat-datepicker-toggle>
                  <mat-datepicker #statusDatePicker></mat-datepicker>
                </mat-form-field>
              </div>
            </div>
          </mat-tab>

          <!-- Monthly Deduction Tab -->
          <mat-tab label="Monthly Deduction">
            <div class="tab-content p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <h3 class="col-span-2 text-lg font-semibold text-gray-700 mb-4">Monthly Deductions</h3>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Share Deduction</mat-label>
                  <input matInput type="number" formControlName="deductionShare">
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Withdrawal Deduction</mat-label>
                  <input matInput type="number" formControlName="deductionWithdrawal">
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>G Loan Instalment</mat-label>
                  <input matInput type="number" formControlName="deductionGLoanInstalment">
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>E Loan Instalment</mat-label>
                  <input matInput type="number" formControlName="deductionELoanInstalment">
                </mat-form-field>
              </div>
            </div>
          </mat-tab>

        </mat-tab-group>

        <div class="border-t border-gray-200 pt-6 mt-6">
          <div class="flex flex-col sm:flex-row gap-4">
            <button mat-raised-button color="primary" type="submit" class="w-full sm:w-auto" [disabled]="!memberForm.valid">
              <mat-icon>{{editingMember ? 'update' : 'add'}}</mat-icon>
              {{editingMember ? 'Update Member' : 'Add Member'}}
            </button>
            <button mat-button type="button" (click)="closeMemberForm()" class="w-full sm:w-auto">
              Cancel
            </button>
          </div>
        </div>
      </form>
    </div>
  </mat-drawer>
</mat-drawer-container>